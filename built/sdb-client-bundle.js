!function(t){var e={};function i(n){if(e[n])return e[n].exports;var r=e[n]={i:n,l:!1,exports:{}};return t[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:n})},i.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=17)}([function(t,e,i){e.defaultType=i(10).type,e.map={},e.register=function(t){t.name&&(e.map[t.name]=t),t.uri&&(e.map[t.uri]=t)},e.register(e.defaultType)},function(t,e,i){function n(t,e){n.super.call(this,e),this.code=t}i(11)(n),t.exports=n},function(t,e,i){var n=i(12).EventEmitter;e.EventEmitter=n,e.mixin=function(t){for(var e in n.prototype)t.prototype[e]=n.prototype[e]}},function(t,e){var i,n,r=t.exports={};function s(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function h(t){if(i===setTimeout)return setTimeout(t,0);if((i===s||!i)&&setTimeout)return i=setTimeout,setTimeout(t,0);try{return i(t,0)}catch(e){try{return i.call(null,t,0)}catch(e){return i.call(this,t,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:s}catch(t){i=s}try{n="function"==typeof clearTimeout?clearTimeout:o}catch(t){n=o}}();var l,c=[],p=!1,a=-1;function u(){p&&l&&(p=!1,l.length?c=l.concat(c):a=-1,c.length&&d())}function d(){if(!p){var t=h(u);p=!0;for(var e=c.length;e;){for(l=c,c=[];++a<e;)l&&l[a].run();a=-1,e=c.length}l=null,p=!1,function(t){if(n===clearTimeout)return clearTimeout(t);if((n===o||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(t);try{n(t)}catch(e){try{return n.call(null,t)}catch(e){return n.call(this,t)}}}(t)}}function f(t,e){this.fun=t,this.array=e}function v(){}r.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];c.push(new f(t,e)),1!==c.length||p||h(d)},f.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=v,r.addListener=v,r.once=v,r.off=v,r.removeListener=v,r.removeAllListeners=v,r.emit=v,r.prependListener=v,r.prependOnceListener=v,r.listeners=function(t){return[]},r.binding=function(t){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(t){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},function(t,e,i){(function(e){var n=i(2);function r(t,e,i,r,s,o,h){n.EventEmitter.call(this),this.action=t,this.connection=e,this.id=i,this.collection=r,this.query=s,this.results=null,o&&o.results&&(this.results=o.results,delete o.results),this.extra=void 0,this.options=o,this.callback=h,this.ready=!1,this.sent=!1}t.exports=r,n.mixin(r),r.prototype.hasPending=function(){return!this.ready},r.prototype.send=function(){if(this.connection.canSend){var t={a:this.action,id:this.id,c:this.collection,q:this.query};if(this.options&&(t.o=this.options),this.results){for(var e=[],i=0;i<this.results.length;i++){var n=this.results[i];e.push([n.id,n.version])}t.r=e}this.connection.send(t),this.sent=!0}},r.prototype.destroy=function(t){this.connection.canSend&&"qs"===this.action&&this.connection.send({a:"qu",id:this.id}),this.connection._destroyQuery(this),t&&e.nextTick(t)},r.prototype._onConnectionStateChanged=function(){this.connection.canSend&&!this.sent?this.send():this.sent=!1},r.prototype._handleFetch=function(t,e,i){this.connection._destroyQuery(this),this._handleResponse(t,e,i)},r.prototype._handleSubscribe=function(t,e,i){this._handleResponse(t,e,i)},r.prototype._handleResponse=function(t,e,i){var n=this.callback;if(this.callback=null,t)return this._finishResponse(t,n);if(!e)return this._finishResponse(null,n);var r=this,s=1,o=function(t){if(t)return r._finishResponse(t,n);--s||r._finishResponse(null,n)};if(Array.isArray(e))s+=e.length,this.results=this._ingestSnapshots(e,o),this.extra=i;else for(var h in e){s++;var l=e[h];this.connection.get(l.c||this.collection,h).ingestSnapshot(l,o)}o()},r.prototype._ingestSnapshots=function(t,e){for(var i=[],n=0;n<t.length;n++){var r=t[n],s=this.connection.get(r.c||this.collection,r.d);s.ingestSnapshot(r,e),i.push(s)}return i},r.prototype._finishResponse=function(t,e){if(this.emit("ready"),this.ready=!0,t)return this.connection._destroyQuery(this),e?e(t):this.emit("error",t);e&&e(null,this.results,this.extra)},r.prototype._handleError=function(t){this.emit("error",t)},r.prototype._handleDiff=function(t){for(var e=0;e<t.length;e++){"insert"===(i=t[e]).type&&(i.values=this._ingestSnapshots(i.values))}for(e=0;e<t.length;e++){var i;switch((i=t[e]).type){case"insert":var n=i.values;Array.prototype.splice.apply(this.results,[i.index,0].concat(n)),this.emit("insert",n,i.index);break;case"remove":var r=i.howMany||1,s=this.results.splice(i.index,r);this.emit("remove",s,i.index);break;case"move":r=i.howMany||1;var o=this.results.splice(i.from,r);Array.prototype.splice.apply(this.results,[i.to,0].concat(o)),this.emit("move",o,i.from,i.to)}}this.emit("changed",this.results)},r.prototype._handleExtra=function(t){this.extra=t,this.emit("extra",t)}}).call(this,i(3))},function(t,e){t.exports=function(t,e,i,n){var r=function(t,i,n,r){e(n,t,i,"left"),e(r,i,t,"right")},s=t.transformX=function(t,e){i(t),i(e);for(var o=[],h=0;h<e.length;h++){for(var l=e[h],c=[],p=0;p<t.length;){var a=[];if(r(t[p],l,c,a),p++,1!==a.length){if(0===a.length){for(var u=p;u<t.length;u++)n(c,t[u]);l=null;break}for(var d=s(t.slice(p),a),f=0;f<d[0].length;f++)n(c,d[0][f]);for(var v=0;v<d[1].length;v++)n(o,d[1][v]);l=null;break}l=a[0]}null!=l&&n(o,l),t=c}return[t,o]};t.transform=function(t,i,n){if("left"!==n&&"right"!==n)throw new Error("type must be 'left' or 'right'");return 0===i.length?t:1===t.length&&1===i.length?e([],t[0],i[0],n):"left"===n?s(t,i)[0]:s(i,t)[1]}}},function(t,e,i){(function(e){var n=i(2),r=i(1),s=i(0);function o(t,e,i){n.EventEmitter.call(this),this.connection=t,this.collection=e,this.id=i,this.version=null,this.type=null,this.data=void 0,this.inflightFetch=[],this.inflightSubscribe=[],this.inflightUnsubscribe=[],this.pendingFetch=[],this.subscribed=!1,this.wantSubscribe=!1,this.inflightOp=null,this.pendingOps=[],this.type=null,this.applyStack=null,this.preventCompose=!1}function h(t,e,i){if(e){var n=t.pop();t.push(function(t){n&&n(t),i&&i(t)})}else t.push(i)}function l(t,e){if(t.del)return delete(i=e).op,delete i.create,void delete i.del;var i;if(e.del)return new r(4017,"Document was deleted");if(e.create)return new r(4018,"Document alredy created");if(e.op){if(t.create)return new r(4018,"Document already created");if(t.type.transformX){var n=t.type.transformX(t.op,e.op);t.op=n[0],e.op=n[1]}else{var s=t.type.transform(t.op,e.op,"left"),o=t.type.transform(e.op,t.op,"right");t.op=s,e.op=o}}}function c(t,e){for(var i=!1,n=0;n<t.length;n++){var r=t[n];r&&(r(e),i=!0)}return i}t.exports=o,n.mixin(o),o.prototype.destroy=function(t){var e=this;e.whenNothingPending(function(){if(e.connection._destroyDoc(e),e.wantSubscribe)return e.unsubscribe(t);t&&t()})},o.prototype._setType=function(t){if("string"==typeof t&&(t=s.map[t]),t)this.type=t;else{if(null!==t){var e=new r(4008,"Missing type "+t);return this.emit("error",e)}this.type=t,this.data=void 0}},o.prototype.ingestSnapshot=function(t,e){if(!t)return e&&e();if("number"!=typeof t.v){var i=new r(5008,"Missing version in ingested snapshot. "+this.collection+"."+this.id);return e?e(i):this.emit("error",i)}if(this.type||this.hasWritePending()){if(null==this.version){if(this.hasWritePending())return e&&this.once("no write pending",e);i=new r(5009,"Cannot ingest snapshot in doc with null version. "+this.collection+"."+this.id);return e?e(i):this.emit("error",i)}return t.v>this.version?this.fetch(e):e&&e()}if(this.version>t.v)return e&&e();this.version=t.v;var n=void 0===t.type?s.defaultType:t.type;this._setType(n),this.data=this.type&&this.type.deserialize?this.type.deserialize(t.data):t.data,this.emit("load"),e&&e()},o.prototype.whenNothingPending=function(t){this.hasPending()?this.once("nothing pending",t):t()},o.prototype.hasPending=function(){return!!(this.inflightOp||this.pendingOps.length||this.inflightFetch.length||this.inflightSubscribe.length||this.inflightUnsubscribe.length||this.pendingFetch.length)},o.prototype.hasWritePending=function(){return!(!this.inflightOp&&!this.pendingOps.length)},o.prototype._emitNothingPending=function(){this.hasWritePending()||(this.emit("no write pending"),this.hasPending()||this.emit("nothing pending"))},o.prototype._emitResponseError=function(t,e){if(e)return e(t),void this._emitNothingPending();this._emitNothingPending(),this.emit("error",t)},o.prototype._handleFetch=function(t,e){var i=this.inflightFetch.shift();if(t)return this._emitResponseError(t,i);this.ingestSnapshot(e,i),this._emitNothingPending()},o.prototype._handleSubscribe=function(t,e){var i=this.inflightSubscribe.shift();if(t)return this._emitResponseError(t,i);this.wantSubscribe&&(this.subscribed=!0),this.ingestSnapshot(e,i),this._emitNothingPending()},o.prototype._handleUnsubscribe=function(t){var e=this.inflightUnsubscribe.shift();if(t)return this._emitResponseError(t,e);e&&e(),this._emitNothingPending()},o.prototype._handleOp=function(t,e){if(t)return this.inflightOp?(4002===t.code&&(t=null),this._rollback(t)):this.emit("error",t);if(this.inflightOp&&e.src===this.inflightOp.src&&e.seq===this.inflightOp.seq)this._opAcknowledged(e);else if(null==this.version||e.v>this.version)this.fetch();else if(!(e.v<this.version)){if(this.inflightOp)if(n=l(this.inflightOp,e))return this._hardRollback(n);for(var i=0;i<this.pendingOps.length;i++){var n;if(n=l(this.pendingOps[i],e))return this._hardRollback(n)}this.version++,this._otApply(e,!1)}},o.prototype._onConnectionStateChanged=function(){if(this.connection.canSend)this.flush(),this._resubscribe();else if(this.inflightOp&&(this.pendingOps.unshift(this.inflightOp),this.inflightOp=null),this.subscribed=!1,(this.inflightFetch.length||this.inflightSubscribe.length)&&(this.pendingFetch=this.pendingFetch.concat(this.inflightFetch,this.inflightSubscribe),this.inflightFetch.length=0,this.inflightSubscribe.length=0),this.inflightUnsubscribe.length){var t=this.inflightUnsubscribe;this.inflightUnsubscribe=[],c(t)}},o.prototype._resubscribe=function(){var t=this.pendingFetch;if(this.pendingFetch=[],this.wantSubscribe)return t.length?void this.subscribe(function(e){c(t,e)}):void this.subscribe();t.length&&this.fetch(function(e){c(t,e)})},o.prototype.fetch=function(t){if(this.connection.canSend){var e=this.connection.sendFetch(this);h(this.inflightFetch,e,t)}else this.pendingFetch.push(t)},o.prototype.subscribe=function(t){if(this.wantSubscribe=!0,this.connection.canSend){var e=this.connection.sendSubscribe(this);h(this.inflightSubscribe,e,t)}else this.pendingFetch.push(t)},o.prototype.unsubscribe=function(t){if(this.wantSubscribe=!1,this.subscribed=!1,this.connection.canSend){var i=this.connection.sendUnsubscribe(this);h(this.inflightUnsubscribe,i,t)}else t&&e.nextTick(t)},o.prototype.flush=function(){this.connection.canSend&&!this.inflightOp&&!this.paused&&this.pendingOps.length&&this._sendOp()},o.prototype._otApply=function(t,e){if(t.op){if(!this.type){var i=new r(4015,"Cannot apply op to uncreated document. "+this.collection+"."+this.id);return this.emit("error",i)}if(!e&&this.type===s.defaultType&&t.op.length>1){this.applyStack||(this.applyStack=[]);for(var n=this.applyStack.length,o=0;o<t.op.length;o++){for(var h={op:[t.op[o]]},c=n;c<this.applyStack.length;c++){var p=l(this.applyStack[c],h);if(p)return this._hardRollback(p)}this.emit("before op",h.op,e),this.data=this.type.apply(this.data,h.op),this.emit("op",h.op,e)}return void this._popApplyStack(n)}return this.emit("before op",t.op,e),this.data=this.type.apply(this.data,t.op),void this.emit("op",t.op,e)}if(t.create)return this._setType(t.create.type),this.data=this.type.deserialize?this.type.createDeserialized?this.type.createDeserialized(t.create.data):this.type.deserialize(this.type.create(t.create.data)):this.type.create(t.create.data),void this.emit("create",e);if(t.del){var a=this.data;return this._setType(null),void this.emit("del",a,e)}},o.prototype._sendOp=function(){var t=this.connection.id;if(t){this.inflightOp||(this.inflightOp=this.pendingOps.shift());var e=this.inflightOp;if(!e){var i=new r(5010,"No op to send on call to _sendOp");return this.emit("error",i)}e.sentAt=Date.now(),e.retries=null==e.retries?0:e.retries+1,null==e.seq&&(e.seq=this.connection.seq++),this.connection.sendOp(this,e),null==e.src&&(e.src=t)}},o.prototype._submit=function(t,i,n){if(i||(i=!0),t.op){if(!this.type){var s=new r(4015,"Cannot submit op. Document has not been created. "+this.collection+"."+this.id);return n?n(s):this.emit("error",s)}this.type.normalize&&(t.op=this.type.normalize(t.op))}this._pushOp(t,n),this._otApply(t,i);var o=this;e.nextTick(function(){o.flush()})},o.prototype._pushOp=function(t,e){if(this.applyStack)this.applyStack.push(t);else{var i=this._tryCompose(t);if(i)return void i.callbacks.push(e)}t.type=this.type,t.callbacks=[e],this.pendingOps.push(t)},o.prototype._popApplyStack=function(t){if(t>0)this.applyStack.length=t;else{var e=this.applyStack[0];if(this.applyStack=null,e)if(-1!==(n=this.pendingOps.indexOf(e)))for(var i=this.pendingOps.splice(n),n=0;n<i.length;n++){e=i[n];var r=this._tryCompose(e);r?r.callbacks=r.callbacks.concat(e.callbacks):this.pendingOps.push(e)}}},o.prototype._tryCompose=function(t){if(!this.preventCompose){var e=this.pendingOps[this.pendingOps.length-1];if(e)return e.create&&t.op?(e.create.data=this.type.apply(e.create.data,t.op),e):e.op&&t.op&&this.type.compose?(e.op=this.type.compose(e.op,t.op),e):void 0}},o.prototype.submitOp=function(t,e,i){"function"==typeof e&&(i=e,e=null);var n={op:t},r=e&&e.source;this._submit(n,r,i)},o.prototype.create=function(t,e,i,n){if("function"==typeof e?(n=e,i=null,e=null):"function"==typeof i&&(n=i,i=null),e||(e=s.defaultType.uri),this.type){var o=new r(4016,"Document already exists");return n?n(o):this.emit("error",o)}var h={create:{type:e,data:t}},l=i&&i.source;this._submit(h,l,n)},o.prototype.del=function(t,e){if("function"==typeof t&&(e=t,t=null),!this.type){var i=new r(4015,"Document does not exist");return e?e(i):this.emit("error",i)}var n=t&&t.source;this._submit({del:!0},n,e)},o.prototype.pause=function(){this.paused=!0},o.prototype.resume=function(){this.paused=!1,this.flush()},o.prototype._opAcknowledged=function(t){if(this.inflightOp.create)this.version=t.v;else if(t.v!==this.version)return console.warn("Invalid version from server. Expected: "+this.version+" Received: "+t.v,t),this.fetch();this.version++,this._clearInflightOp()},o.prototype._rollback=function(t){var e=this.inflightOp;if(e.op&&e.type.invert){e.op=e.type.invert(e.op);for(var i=0;i<this.pendingOps.length;i++){var n=l(this.pendingOps[i],e);if(n)return this._hardRollback(n)}return this._otApply(e,!1),void this._clearInflightOp(t)}this._hardRollback(t)},o.prototype._hardRollback=function(t){var e=this.inflightOp,i=this.pendingOps;this._setType(null),this.version=null,this.inflightOp=null,this.pendingOps=[];var n=this;this.fetch(function(){for(var r=e&&c(e.callbacks,t),s=0;s<i.length;s++)c(i[s].callbacks,t);if(t&&!r)return n.emit("error",t)})},o.prototype._clearInflightOp=function(t){var e=c(this.inflightOp.callbacks,t);if(this.inflightOp=null,this.flush(),this._emitNothingPending(),t&&!e)return this.emit("error",t)}}).call(this,i(3))},function(t,e){e.doNothing=function(){},e.hasKeys=function(t){for(var e in t)return!0;return!1}},function(t,e,i){var n=t.exports={name:"text0",uri:"http://sharejs.org/types/textv0",create:function(t){if(null!=t&&"string"!=typeof t)throw new Error("Initial data must be a string");return t||""}},r=function(t,e,i){return t.slice(0,e)+i+t.slice(e)},s=function(t){if("number"!=typeof t.p)throw new Error("component missing position field");if("string"==typeof t.i==("string"==typeof t.d))throw new Error("component needs an i or d field");if(t.p<0)throw new Error("position cannot be negative")},o=function(t){for(var e=0;e<t.length;e++)s(t[e])};n.apply=function(t,e){var i;o(e);for(var n=0;n<e.length;n++){var s=e[n];if(null!=s.i)t=r(t,s.p,s.i);else{if(i=t.slice(s.p,s.p+s.d.length),s.d!==i)throw new Error("Delete component '"+s.d+"' does not match deleted text '"+i+"'");t=t.slice(0,s.p)+t.slice(s.p+s.d.length)}}return t};var h=n._append=function(t,e){if(""!==e.i&&""!==e.d)if(0===t.length)t.push(e);else{var i=t[t.length-1];null!=i.i&&null!=e.i&&i.p<=e.p&&e.p<=i.p+i.i.length?t[t.length-1]={i:r(i.i,e.p-i.p,e.i),p:i.p}:null!=i.d&&null!=e.d&&e.p<=i.p&&i.p<=e.p+e.d.length?t[t.length-1]={d:r(e.d,i.p-e.p,i.d),p:e.p}:t.push(e)}};n.compose=function(t,e){o(t),o(e);for(var i=t.slice(),n=0;n<e.length;n++)h(i,e[n]);return i},n.normalize=function(t){var e=[];null==t.i&&null==t.p||(t=[t]);for(var i=0;i<t.length;i++){var n=t[i];null==n.p&&(n.p=0),h(e,n)}return e};var l=function(t,e,i){return null!=e.i?e.p<t||e.p===t&&i?t+e.i.length:t:t<=e.p?t:t<=e.p+e.d.length?e.p:t-e.d.length};n.transformCursor=function(t,e,i){for(var n="right"===i,r=0;r<e.length;r++)t=l(t,e[r],n);return t};var c=n._tc=function(t,e,i,n){if(s(e),s(i),null!=e.i)h(t,{i:e.i,p:l(e.p,i,"right"===n)});else if(null!=i.i){var r=e.d;e.p<i.p&&(h(t,{d:r.slice(0,i.p-e.p),p:e.p}),r=r.slice(i.p-e.p)),""!==r&&h(t,{d:r,p:e.p+i.i.length})}else if(e.p>=i.p+i.d.length)h(t,{d:e.d,p:e.p-i.d.length});else if(e.p+e.d.length<=i.p)h(t,e);else{var o={d:"",p:e.p};e.p<i.p&&(o.d=e.d.slice(0,i.p-e.p)),e.p+e.d.length>i.p+i.d.length&&(o.d+=e.d.slice(i.p+i.d.length-e.p));var c=Math.max(e.p,i.p),p=Math.min(e.p+e.d.length,i.p+i.d.length);if(e.d.slice(c-e.p,p-e.p)!==i.d.slice(c-i.p,p-i.p))throw new Error("Delete ops delete different text in the same region of the document");""!==o.d&&(o.p=l(o.p,i),h(t,o))}return t};n.invert=function(t){t=t.slice().reverse();for(var e=0;e<t.length;e++)t[e]=null!=(i=t[e]).i?{d:i.i,p:i.p}:{i:i.d,p:i.p};var i;return t},i(5)(n,c,o,h)},function(t,e,i){var n=function(t){return"[object Array]"==Object.prototype.toString.call(t)},r=function(t){return JSON.parse(JSON.stringify(t))},s={name:"json0",uri:"http://sharejs.org/types/JSONv0"},o={};function h(t){t.t="text0";var e={p:t.p.pop()};null!=t.si&&(e.i=t.si),null!=t.sd&&(e.d=t.sd),t.o=[e]}function l(t){t.p.push(t.o[0].p),null!=t.o[0].i&&(t.si=t.o[0].i),null!=t.o[0].d&&(t.sd=t.o[0].d),delete t.t,delete t.o}s.registerSubtype=function(t){o[t.name]=t},s.create=function(t){return void 0===t?null:r(t)},s.invertComponent=function(t){var e={p:t.p};return t.t&&o[t.t]&&(e.t=t.t,e.o=o[t.t].invert(t.o)),void 0!==t.si&&(e.sd=t.si),void 0!==t.sd&&(e.si=t.sd),void 0!==t.oi&&(e.od=t.oi),void 0!==t.od&&(e.oi=t.od),void 0!==t.li&&(e.ld=t.li),void 0!==t.ld&&(e.li=t.ld),void 0!==t.na&&(e.na=-t.na),void 0!==t.lm&&(e.lm=t.p[t.p.length-1],e.p=t.p.slice(0,t.p.length-1).concat([t.lm])),e},s.invert=function(t){for(var e=t.slice().reverse(),i=[],n=0;n<e.length;n++)i.push(s.invertComponent(e[n]));return i},s.checkValidOp=function(t){for(var e=0;e<t.length;e++)if(!n(t[e].p))throw new Error("Missing path")},s.checkList=function(t){if(!n(t))throw new Error("Referenced element not a list")},s.checkObj=function(t){if(!(e=t)||e.constructor!==Object)throw new Error("Referenced element not an object (it was "+JSON.stringify(t)+")");var e},s.apply=function(t,e){s.checkValidOp(e),e=r(e);for(var i={data:t},n=0;n<e.length;n++){var l=e[n];null==l.si&&null==l.sd||h(l);for(var c=null,p=i,a="data",u=0;u<l.p.length;u++){var d=l.p[u];if(c=p,a,p=p[a],a=d,null==c)throw new Error("Path invalid")}if(l.t&&void 0!==l.o&&o[l.t])p[a]=o[l.t].apply(p[a],l.o);else if(void 0!==l.na){if("number"!=typeof p[a])throw new Error("Referenced element not a number");p[a]+=l.na}else if(void 0!==l.li&&void 0!==l.ld)s.checkList(p),p[a]=l.li;else if(void 0!==l.li)s.checkList(p),p.splice(a,0,l.li);else if(void 0!==l.ld)s.checkList(p),p.splice(a,1);else if(void 0!==l.lm){if(s.checkList(p),l.lm!=a){var f=p[a];p.splice(a,1),p.splice(l.lm,0,f)}}else if(void 0!==l.oi)s.checkObj(p),p[a]=l.oi;else{if(void 0===l.od)throw new Error("invalid / missing instruction in op");s.checkObj(p),delete p[a]}}return i.data},s.shatter=function(t){for(var e=[],i=0;i<t.length;i++)e.push([t[i]]);return e},s.incrementalApply=function(t,e,i){for(var n=0;n<e.length;n++){var r=[e[n]];i(r,t=s.apply(t,r))}return t};var c=s.pathMatches=function(t,e,i){if(t.length!=e.length)return!1;for(var n=0;n<t.length;n++)if(t[n]!==e[n]&&(!i||n!==t.length-1))return!1;return!0};s.append=function(t,e){if(e=r(e),0!==t.length){var i=t[t.length-1];if(null==e.si&&null==e.sd||null==i.si&&null==i.sd||(h(e),h(i)),c(e.p,i.p))if(e.t&&i.t&&e.t===i.t&&o[e.t]){if(i.o=o[e.t].compose(i.o,e.o),null!=e.si||null!=e.sd){for(var n=e.p,s=0;s<i.o.length-1;s++)e.o=[i.o.pop()],e.p=n.slice(),l(e),t.push(e);l(i)}}else null!=i.na&&null!=e.na?t[t.length-1]={p:i.p,na:i.na+e.na}:void 0!==i.li&&void 0===e.li&&e.ld===i.li?void 0!==i.ld?delete i.li:t.pop():void 0!==i.od&&void 0===i.oi&&void 0!==e.oi&&void 0===e.od?i.oi=e.oi:void 0!==i.oi&&void 0!==e.od?void 0!==e.oi?i.oi=e.oi:void 0!==i.od?delete i.oi:t.pop():void 0!==e.lm&&e.p[e.p.length-1]===e.lm||t.push(e);else null==e.si&&null==e.sd||null==i.si&&null==i.sd||(l(e),l(i)),t.push(e)}else t.push(e)},s.compose=function(t,e){s.checkValidOp(t),s.checkValidOp(e);for(var i=r(t),n=0;n<e.length;n++)s.append(i,e[n]);return i},s.normalize=function(t){var e=[];t=n(t)?t:[t];for(var i=0;i<t.length;i++){var r=t[i];null==r.p&&(r.p=[]),s.append(e,r)}return e},s.commonLengthForOps=function(t,e){var i=t.p.length,n=e.p.length;if((null!=t.na||t.t)&&i++,(null!=e.na||e.t)&&n++,0===i)return-1;if(0===n)return null;i--,n--;for(var r=0;r<i;r++){var s=t.p[r];if(r>=n||s!==e.p[r])return null}return i},s.canOpAffectPath=function(t,e){return null!=s.commonLengthForOps({p:e},t)},s.transformComponent=function(t,e,i,c){e=r(e);var p=s.commonLengthForOps(i,e),a=s.commonLengthForOps(e,i),u=e.p.length,d=i.p.length;if((null!=e.na||e.t)&&u++,(null!=i.na||i.t)&&d++,null!=a&&d>u&&e.p[a]==i.p[a])if(void 0!==e.ld)(v=r(i)).p=v.p.slice(u),e.ld=s.apply(r(e.ld),[v]);else if(void 0!==e.od){(v=r(i)).p=v.p.slice(u),e.od=s.apply(r(e.od),[v])}if(null!=p){var f=u==d,v=i;if(null==e.si&&null==e.sd||null==i.si&&null==i.sd||(h(e),h(v=r(i))),v.t&&o[v.t]){if(e.t&&e.t===v.t){var g=o[e.t].transform(e.o,v.o,c);if(null!=e.si||null!=e.sd)for(var y=e.p,m=0;m<g.length;m++)e.o=[g[m]],e.p=y.slice(),l(e),s.append(t,e);else(!n(g)||g.length>0)&&(e.o=g,s.append(t,e));return t}}else if(void 0!==i.na);else if(void 0!==i.li&&void 0!==i.ld){if(i.p[p]===e.p[p]){if(!f)return t;if(void 0!==e.ld){if(void 0===e.li||"left"!==c)return t;e.ld=r(i.li)}}}else if(void 0!==i.li)void 0!==e.li&&void 0===e.ld&&f&&e.p[p]===i.p[p]?"right"===c&&e.p[p]++:i.p[p]<=e.p[p]&&e.p[p]++,void 0!==e.lm&&f&&i.p[p]<=e.lm&&e.lm++;else if(void 0!==i.ld){if(void 0!==e.lm&&f){if(i.p[p]===e.p[p])return t;y=i.p[p];var b=e.p[p];(y<(_=e.lm)||y===_&&b<_)&&e.lm--}if(i.p[p]<e.p[p])e.p[p]--;else if(i.p[p]===e.p[p]){if(d<u)return t;if(void 0!==e.ld){if(void 0===e.li)return t;delete e.ld}}}else if(void 0!==i.lm)if(void 0!==e.lm&&u===d){b=e.p[p];var _=e.lm,w=i.p[p],O=i.lm;if(w!==O)if(b===w){if("left"!==c)return t;e.p[p]=O,b===_&&(e.lm=O)}else b>w&&e.p[p]--,b>O?e.p[p]++:b===O&&w>O&&(e.p[p]++,b===_&&e.lm++),_>w?e.lm--:_===w&&_>b&&e.lm--,_>O?e.lm++:_===O&&(O>w&&_>b||O<w&&_<b?"right"===c&&e.lm++:_>b?e.lm++:_===w&&e.lm--)}else if(void 0!==e.li&&void 0===e.ld&&f){b=i.p[p],_=i.lm;(y=e.p[p])>b&&e.p[p]--,y>_&&e.p[p]++}else{b=i.p[p],_=i.lm;(y=e.p[p])===b?e.p[p]=_:(y>b&&e.p[p]--,y>_?e.p[p]++:y===_&&b>_&&e.p[p]++)}else if(void 0!==i.oi&&void 0!==i.od){if(e.p[p]===i.p[p]){if(void 0===e.oi||!f)return t;if("right"===c)return t;e.od=i.oi}}else if(void 0!==i.oi){if(void 0!==e.oi&&e.p[p]===i.p[p]){if("left"!==c)return t;s.append(t,{p:e.p,od:i.oi})}}else if(void 0!==i.od&&e.p[p]==i.p[p]){if(!f)return t;if(void 0===e.oi)return t;delete e.od}}return s.append(t,e),t},i(5)(s,s.transformComponent,s.checkValidOp,s.append);var p=i(8);s.registerSubtype(p),t.exports=s},function(t,e,i){t.exports={type:i(9)}},function(t,e,i){"use strict";var n="undefined"!=typeof Reflect?Reflect.construct:void 0,r=Object.defineProperty,s=Error.captureStackTrace;function o(t){void 0!==t&&r(this,"message",{configurable:!0,value:t,writable:!0});var e=this.constructor.name;void 0!==e&&e!==this.name&&r(this,"name",{configurable:!0,value:e,writable:!0}),s(this,this.constructor)}void 0===s&&(s=function(t){var e=new Error;r(t,"stack",{configurable:!0,get:function(){var t=e.stack;return r(this,"stack",{configurable:!0,value:t,writable:!0}),t},set:function(e){r(t,"stack",{configurable:!0,value:e,writable:!0})}})}),o.prototype=Object.create(Error.prototype,{constructor:{configurable:!0,value:o,writable:!0}});var h=function(){function t(t,e){return r(t,"name",{configurable:!0,value:e})}try{var e=function(){};if(t(e,"foo"),"foo"===e.name)return t}catch(t){}}();(t.exports=function(t,e){if(null==e||e===Error)e=o;else if("function"!=typeof e)throw new TypeError("super_ should be a function");var i;if("string"==typeof t)i=t,t=void 0!==n?function(){return n(e,arguments,this.constructor)}:function(){e.apply(this,arguments)},void 0!==h&&(h(t,i),i=void 0);else if("function"!=typeof t)throw new TypeError("constructor should be either a string or a function");t.super_=t.super=e;var r={constructor:{configurable:!0,value:t,writable:!0}};return void 0!==i&&(r.name={configurable:!0,value:i,writable:!0}),t.prototype=Object.create(e.prototype,r),t}).BaseError=o},function(t,e){function i(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function n(t){return"function"==typeof t}function r(t){return"object"==typeof t&&null!==t}function s(t){return void 0===t}t.exports=i,i.EventEmitter=i,i.prototype._events=void 0,i.prototype._maxListeners=void 0,i.defaultMaxListeners=10,i.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||isNaN(t))throw TypeError("n must be a positive number");return this._maxListeners=t,this},i.prototype.emit=function(t){var e,i,o,h,l,c;if(this._events||(this._events={}),"error"===t&&(!this._events.error||r(this._events.error)&&!this._events.error.length)){if((e=arguments[1])instanceof Error)throw e;var p=new Error('Uncaught, unspecified "error" event. ('+e+")");throw p.context=e,p}if(s(i=this._events[t]))return!1;if(n(i))switch(arguments.length){case 1:i.call(this);break;case 2:i.call(this,arguments[1]);break;case 3:i.call(this,arguments[1],arguments[2]);break;default:h=Array.prototype.slice.call(arguments,1),i.apply(this,h)}else if(r(i))for(h=Array.prototype.slice.call(arguments,1),o=(c=i.slice()).length,l=0;l<o;l++)c[l].apply(this,h);return!0},i.prototype.addListener=function(t,e){var o;if(!n(e))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",t,n(e.listener)?e.listener:e),this._events[t]?r(this._events[t])?this._events[t].push(e):this._events[t]=[this._events[t],e]:this._events[t]=e,r(this._events[t])&&!this._events[t].warned&&(o=s(this._maxListeners)?i.defaultMaxListeners:this._maxListeners)&&o>0&&this._events[t].length>o&&(this._events[t].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[t].length),"function"==typeof console.trace&&console.trace()),this},i.prototype.on=i.prototype.addListener,i.prototype.once=function(t,e){if(!n(e))throw TypeError("listener must be a function");var i=!1;function r(){this.removeListener(t,r),i||(i=!0,e.apply(this,arguments))}return r.listener=e,this.on(t,r),this},i.prototype.removeListener=function(t,e){var i,s,o,h;if(!n(e))throw TypeError("listener must be a function");if(!this._events||!this._events[t])return this;if(o=(i=this._events[t]).length,s=-1,i===e||n(i.listener)&&i.listener===e)delete this._events[t],this._events.removeListener&&this.emit("removeListener",t,e);else if(r(i)){for(h=o;h-- >0;)if(i[h]===e||i[h].listener&&i[h].listener===e){s=h;break}if(s<0)return this;1===i.length?(i.length=0,delete this._events[t]):i.splice(s,1),this._events.removeListener&&this.emit("removeListener",t,e)}return this},i.prototype.removeAllListeners=function(t){var e,i;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[t]&&delete this._events[t],this;if(0===arguments.length){for(e in this._events)"removeListener"!==e&&this.removeAllListeners(e);return this.removeAllListeners("removeListener"),this._events={},this}if(n(i=this._events[t]))this.removeListener(t,i);else if(i)for(;i.length;)this.removeListener(t,i[i.length-1]);return delete this._events[t],this},i.prototype.listeners=function(t){return this._events&&this._events[t]?n(this._events[t])?[this._events[t]]:this._events[t].slice():[]},i.prototype.listenerCount=function(t){if(this._events){var e=this._events[t];if(n(e))return 1;if(e)return e.length}return 0},i.listenerCount=function(t,e){return t.listenerCount(e)}},function(t,e,i){(function(e){var n=i(6),r=i(4),s=i(2),o=i(1),h=i(0),l=i(7);function c(t){s.EventEmitter.call(this),this.collections={},this.nextQueryId=1,this.queries={},this.seq=1,this.id=null,this.agent=null,this.debug=!1,this.bindToSocket(t)}function p(t){return t.hasPending()}function a(t){return t.hasWritePending()}t.exports=c,s.mixin(c),c.prototype.bindToSocket=function(t){this.socket&&(this.socket.close(),this.socket.onmessage=null,this.socket.onopen=null,this.socket.onerror=null,this.socket.onclose=null),this.socket=t,this.state=0===t.readyState||1===t.readyState?"connecting":"disconnected",this.canSend=!1;var i=this;t.onmessage=function(t){try{var n="string"==typeof t.data?JSON.parse(t.data):t.data}catch(e){return void console.warn("Failed to parse message",t)}i.debug&&console.log("RECV",JSON.stringify(n));var r={data:n};if(i.emit("receive",r),r.data)try{i.handleMessage(r.data)}catch(t){e.nextTick(function(){i.emit("error",t)})}},t.onopen=function(){i._setState("connecting")},t.onerror=function(t){i.emit("connection error",t)},t.onclose=function(t){"closed"===t||"Closed"===t?i._setState("closed",t):"stopped"===t||"Stopped by server"===t?i._setState("stopped",t):i._setState("disconnected",t)}},c.prototype.handleMessage=function(t){var e=null;switch(t.error&&((e=new Error(t.error.message)).code=t.error.code,e.data=t,delete t.error),t.a){case"init":return 1!==t.protocol?(e=new o(4019,"Invalid protocol version"),this.emit("error",e)):h.map[t.type]!==h.defaultType?(e=new o(4020,"Invalid default type"),this.emit("error",e)):"string"!=typeof t.id?(e=new o(4021,"Invalid client id"),this.emit("error",e)):(this.id=t.id,void this._setState("connected"));case"qf":return void((i=this.queries[t.id])&&i._handleFetch(e,t.data,t.extra));case"qs":return void((i=this.queries[t.id])&&i._handleSubscribe(e,t.data,t.extra));case"qu":return;case"q":var i;if(!(i=this.queries[t.id]))return;return e?i._handleError(e):(t.diff&&i._handleDiff(t.diff),void(t.hasOwnProperty("extra")&&i._handleExtra(t.extra)));case"bf":return this._handleBulkMessage(t,"_handleFetch");case"bs":return this._handleBulkMessage(t,"_handleSubscribe");case"bu":return this._handleBulkMessage(t,"_handleUnsubscribe");case"f":return void((n=this.getExisting(t.c,t.d))&&n._handleFetch(e,t.data));case"s":return void((n=this.getExisting(t.c,t.d))&&n._handleSubscribe(e,t.data));case"u":return void((n=this.getExisting(t.c,t.d))&&n._handleUnsubscribe(e));case"op":var n;return void((n=this.getExisting(t.c,t.d))&&n._handleOp(e,t));default:console.warn("Ignoring unrecognized message",t)}},c.prototype._handleBulkMessage=function(t,e){if(t.data)for(var i in t.data){(r=this.getExisting(t.c,i))&&r[e](t.error,t.data[i])}else if(Array.isArray(t.b))for(var n=0;n<t.b.length;n++){i=t.b[n];(r=this.getExisting(t.c,i))&&r[e](t.error)}else if(t.b)for(var i in t.b){var r;(r=this.getExisting(t.c,i))&&r[e](t.error)}else console.error("Invalid bulk message",t)},c.prototype._reset=function(){this.seq=1,this.id=null,this.agent=null},c.prototype._setState=function(t,e){if(this.state!==t){if("connecting"===t&&"disconnected"!==this.state&&"stopped"!==this.state&&"closed"!==this.state||"connected"===t&&"connecting"!==this.state){var i=new o(5007,"Cannot transition directly from "+this.state+" to "+t);return this.emit("error",i)}for(var n in this.state=t,this.canSend="connected"===t,"disconnected"!==t&&"stopped"!==t&&"closed"!==t||this._reset(),this.startBulk(),this.queries){this.queries[n]._onConnectionStateChanged()}for(var r in this.collections){var s=this.collections[r];for(var n in s)s[n]._onConnectionStateChanged()}this.endBulk(),this.emit(t,e),this.emit("state",t,e)}},c.prototype.startBulk=function(){this.bulk||(this.bulk={})},c.prototype.endBulk=function(){if(this.bulk)for(var t in this.bulk){var e=this.bulk[t];this._sendBulk("f",t,e.f),this._sendBulk("s",t,e.s),this._sendBulk("u",t,e.u)}this.bulk=null},c.prototype._sendBulk=function(t,e,i){if(i){var n,r=[],s={},o=0;for(var h in i){var l=i[h];null==l?r.push(h):(s[h]=l,n=h,o++)}if(1===r.length){h=r[0];this.send({a:t,c:e,d:h})}else r.length&&this.send({a:"b"+t,c:e,b:r});if(1===o){var c=s[n];this.send({a:t,c:e,d:n,v:c})}else o&&this.send({a:"b"+t,c:e,b:s})}},c.prototype._sendAction=function(t,e,i){if(this._addDoc(e),this.bulk){var n=this.bulk[e.collection]||(this.bulk[e.collection]={}),r=n[t]||(n[t]={}),s=r.hasOwnProperty(e.id);return r[e.id]=i,s}var o={a:t,c:e.collection,d:e.id,v:i};this.send(o)},c.prototype.sendFetch=function(t){return this._sendAction("f",t,t.version)},c.prototype.sendSubscribe=function(t){return this._sendAction("s",t,t.version)},c.prototype.sendUnsubscribe=function(t){return this._sendAction("u",t)},c.prototype.sendOp=function(t,e){this._addDoc(t);var i={a:"op",c:t.collection,d:t.id,v:t.version,src:e.src,seq:e.seq};e.op&&(i.op=e.op),e.create&&(i.create=e.create),e.del&&(i.del=e.del),this.send(i)},c.prototype.send=function(t){this.debug&&console.log("SEND",JSON.stringify(t)),this.emit("send",t),this.socket.send(JSON.stringify(t))},c.prototype.close=function(){this.socket.close()},c.prototype.getExisting=function(t,e){if(this.collections[t])return this.collections[t][e]},c.prototype.get=function(t,e){var i=this.collections[t]||(this.collections[t]={}),r=i[e];return r||(r=i[e]=new n(this,t,e),this.emit("doc",r)),r},c.prototype._destroyDoc=function(t){var e=this.collections[t.collection];e&&(delete e[t.id],l.hasKeys(e)||delete this.collections[t.collection])},c.prototype._addDoc=function(t){var e=this.collections[t.collection];e||(e=this.collections[t.collection]={}),e[t.id]!==t&&(e[t.id]=t)},c.prototype._createQuery=function(t,e,i,n,s){var o=this.nextQueryId++,h=new r(t,this,o,e,i,n,s);return this.queries[o]=h,h.send(),h},c.prototype._destroyQuery=function(t){delete this.queries[t.id]},c.prototype.createFetchQuery=function(t,e,i,n){return this._createQuery("qf",t,e,i,n)},c.prototype.createSubscribeQuery=function(t,e,i,n){return this._createQuery("qs",t,e,i,n)},c.prototype.hasPending=function(){return!(!this._firstDoc(p)&&!this._firstQuery(p))},c.prototype.hasWritePending=function(){return!!this._firstDoc(a)},c.prototype.whenNothingPending=function(t){var i=this._firstDoc(p);if(i)i.once("nothing pending",this._nothingPendingRetry(t));else{var n=this._firstQuery(p);n?n.once("ready",this._nothingPendingRetry(t)):e.nextTick(t)}},c.prototype._nothingPendingRetry=function(t){var i=this;return function(){e.nextTick(function(){i.whenNothingPending(t)})}},c.prototype._firstDoc=function(t){for(var e in this.collections){var i=this.collections[e];for(var n in i){var r=i[n];if(t(r))return r}}},c.prototype._firstQuery=function(t){for(var e in this.queries){var i=this.queries[e];if(t(i))return i}}}).call(this,i(3))},function(t,e,i){e.Connection=i(13),e.Doc=i(6),e.Error=i(1),e.Query=i(4),e.types=i(0)},function(t,e,i){"use strict";var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(r,s){function o(t){try{l(n.next(t))}catch(t){s(t)}}function h(t){try{l(n.throw(t))}catch(t){s(t)}}function l(t){t.done?r(t.value):new i(function(e){e(t.value)}).then(o,h)}l((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});e.SDBDoc=class{constructor(t,e,i){this.docIdentifier=t,this.doc=e,this.sdb=i}getIdentifier(){return this.docIdentifier}getData(){return this.doc.data}traverse(t){let e=this.getData(),i=e;for(let n=0;n<t.length;n++)try{i=e=e[t[n]]}catch(e){throw new Error(`Could not traverse path ${t}. Object ${i} does not have property ${t[n]}`)}return e}submitObjectReplaceOp(t,e,i=this.traverse(t)){return n(this,void 0,void 0,function*(){return yield this.submitOp([{p:t,oi:e,od:i}])})}submitObjectInsertOp(t,e){return n(this,void 0,void 0,function*(){return yield this.submitOp([{p:t,oi:e}])})}submitObjectDeleteOp(t,e=this.traverse(t)){return n(this,void 0,void 0,function*(){return yield this.submitOp([{p:t,od:e}])})}submitListReplaceOp(t,e,i=this.traverse(t)){return n(this,void 0,void 0,function*(){return yield this.submitOp([{p:t,li:e,ld:i}])})}submitListInsertOp(t,e){return n(this,void 0,void 0,function*(){return yield this.submitOp([{p:t,li:e}])})}submitListDeleteOp(t,e=this.traverse(t)){return n(this,void 0,void 0,function*(){return yield this.submitOp([{p:t,ld:e}])})}submitListSpliceOp(t,e,i,...r){return n(this,void 0,void 0,function*(){const n=[],s=this.traverse(t);for(let r=e+i-1;r>=e;r--){const e=t.concat([r]);n.push({p:e,ld:s[r]})}const o=r.map((i,n)=>({p:t.concat([e+n]),li:i}));return yield this.submitOp(n.concat(o))})}submitListPushOp(t,...e){return n(this,void 0,void 0,function*(){const i=this.traverse(t).length,n=e.map((e,n)=>({p:t.concat(i+n),li:e}));return yield this.submitOp(n)})}submitListUnshiftOp(t,...e){return n(this,void 0,void 0,function*(){this.traverse(t).length;const i=e.map((e,i)=>({p:t.concat(i),li:e}));return yield this.submitOp(i)})}fetch(){return new Promise((t,e)=>{this.doc.fetch(i=>{i?e(i):t(this.doc)})})}create(t,e,i){return new Promise((n,r)=>{this.doc.create(t,e,i,()=>{n(this)})})}del(t=!0){return new Promise((e,i)=>{this.doc.del({source:t},t=>{t?i(t):(this.sdb.deleteDoc(this),e())})})}subscribe(t){this.doc.subscribe(e=>{if(e)throw e;t(null,null,this.doc.data)});const e=(e,i)=>{t(e,i,this.doc.data)};return this.doc.on("op",e),()=>{this.doc.removeListener("op",e)}}submitOp(t,e=!0){return new Promise((i,n)=>{this.doc.submitOp(t,{source:e},t=>{t?n(t):i(this)})})}createIfEmpty(t,e,i){return n(this,void 0,void 0,function*(){return null===(yield this.fetch()).type?this.create(t,e,i):this})}destroy(){this.doc.destroy(),this.sdb.deleteDoc(this)}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=i(15);e.SDB=class{constructor(){this.docs=new Map}getDocIdentifier(t,e){return[t,e]}get(t,e){const i=this.getDocIdentifier(t,e);let r;if(this.docs.has(i))r=this.docs.get(i);else{const s=this.connection.get(t,e);r=new n.SDBDoc(i,s,this),this.docs.set(i,r)}return r}deleteDoc(t){this.docs.delete(t.getIdentifier())}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=i(16),r=i(14);e.SDBClient=class extends n.SDB{constructor(t){super(),this.ws=t,this.connection=new r.Connection(t)}close(){return Promise.resolve()}}}]);